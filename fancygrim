#/bin/bash

# fancygrim https://github.com/memyboi/fancygrim

# Default configuration
Shadow=false # whether or not to have a shadow by default, you can enable this with the "--shadow" flag
CornerIntensity=10 # how intense the corners should be, you can modify this with the "--corner" flag

Notification=true # whether or not to send a notification after the screenshot has been taken.
PreNotification=true # whether or not to send a notification after the screenshot has begun processing.
NotificationImage=true # whether or not the notification that is sent after the screenshot is taken should include that screenshot, you can disable this with the "--noimage" flag

CopyToClipboard=true # whether or not to copy the Image do your clipboard, you can disable this with the "--nocopy" flag
PasteOnce=false # whether or not the screenshot can be pasted only once, you can enable this with the "--pasteonce" flag
WriteImage=false # whether or not to write the image to disk, you can enable this with the "--write" flag 
WriteDirectory="/home/$USER/Pictures" # where the image should be written to disk, you can modify this with the "--writedir" flag



usage() {
  echo "Usage:"
  echo "  fancygrim (area|window|full) [--corner (N) | -c (N)] [--shadow | -s] [--silence | -d] [--pasteonce | -o] [--nocopy | -n] [--noimage -i] [--write | -w] [--writedir (PATH) | -p]"
  echo "  fancygrim usage"
  echo ""
  echo "  area:"
  echo "    takes a photo and crops to user's input."
  echo "  window:"
  echo "    takes a photo and crops it to the active window."
  echo "  full:"
  echo "    takes a photo of the whole screen."
  echo "  config:"
  echo "    opens config in your set editor or nano."
}

addshadow() {
  magick /tmp/fancygrimss.png \( +clone -background black -shadow 50x10+15+15 \) +swap -background none -layers merge +repage /tmp/fancygrimss.png
}

addcorners() {
  magick -size $1x$2 xc:none -draw "roundrectangle 0,0,$1,$2,$3,$3" /tmp/fancygrimmask.png
  magick /tmp/fancygrimss.png -matte /tmp/fancygrimmask.png \
    -compose DstIn -composite /tmp/fancygrimss.png
}

write() {
  if [ $WriteImage = true ]; then
    # todo: make this formattable
    SCREENSHOTNAME="screenshot-$(date "+%Y-%m-%d-%I:%M:%S")"
    cp /tmp/fancygrimss.png "$WriteDirectory/$SCREENSHOTNAME.png"
  fi
}

copytoclipboard() {
  if [ $CopyToClipboard = true ]; then
    COPYFLAG=""
    if [ $PasteOnce = true ]; then
      COPYFLAG="-o"
    fi
    wl-copy $COPYFLAG < /tmp/fancygrimss.png
  fi
}

sendnotif() {
  if [ $Notification = true ]; then
    IMAGEFLAG=""
    NOTIFICATIONBODY="screenshot saved to /tmp/fancygrimss.png."
    if [ $NotificationImage = true ]; then
      IMAGEFLAG='-i /tmp/fancygrimss.png'
    fi
    if [ $CopyToClipboard = true ]; then
      NOTIFICATIONBODY='screenshot copied to clipboard.'
    fi
    notify-send -t 2000 "Screenshot taken" "$1 $NOTIFICATIONBODY" $IMAGEFLAG
  fi
}

area() {
  grim "/tmp/fancygrimss.png"
  hyprpicker -z -r &
  sleep 0.2
  HYPRPICKER_PID=$!
  RAWRES=$(slurp)
  IFS=' ' read -ra SPLITRAWRES <<< "$RAWRES"
  IFS=',' read -ra RAWPOS <<< "${SPLITRAWRES[0]}"
  IFS='x' read -ra RAWSIZE <<< "${SPLITRAWRES[1]}"
  RES=${RAWSIZE[0]}x${RAWSIZE[1]}+${RAWPOS[0]}+${RAWPOS[1]}
  if [ "$RES" = "x++" ]; then
    kill "$HYPRPICKER_PID"
  else
    kill "$HYPRPICKER_PID"
    prenotif
    magick /tmp/fancygrimss.png -crop $RES /tmp/fancygrimss.png
    if [ $CornerIntensity -gt 0 ]; then 
      addcorners "${RAWSIZE[0]}" "${RAWSIZE[1]}" "$CornerIntensity"
    fi
    if [ $Shadow = true ]; then
      addshadow
    fi
    copytoclipboard
    sendnotif "Area"
    write
  fi
}

window() { # touch up later, is a little slow.
  RAWRES=$(hyprctl activewindow -j | jq -r '"\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"')
  grim "/tmp/fancygrimss.png"
  prenotif
  IFS=' ' read -ra SPLITRAWRES <<< "$RAWRES"
  IFS=',' read -ra RAWPOS <<< "${SPLITRAWRES[0]}"
  IFS='x' read -ra RAWSIZE <<< "${SPLITRAWRES[1]}"
  POSX=${RAWPOS[0]}
  POSY=${RAWPOS[1]}
  SIZX=${RAWSIZE[0]}
  SIZY=${RAWSIZE[1]}
  RES=${SIZX}x${SIZY}+${POSX}+${POSY}

  magick /tmp/fancygrimss.png -crop $RES /tmp/fancygrimss.png
  if [ $CornerIntensity -gt 0 ]; then
    addcorners "${SIZX}" "${SIZY}" "$CornerIntensity"
  fi
  if [ $Shadow = true ]; then
    addshadow
  fi
  copytoclipboard
  sendnotif "Window"
  write
}

full() {
  grim "/tmp/fancygrimss.png"
  prenotif
  if [ $CornerIntensity -gt 0 ]; then
    SIZE=$(magick /tmp/fancygrimss.png -print "%w %h" /dev/null)
    WIDTH=$(echo $SIZE | cut -d ' ' -f 1)
    HEIGHT=$(echo $SIZE | cut -d ' ' -f 2)
    addcorners "$WIDTH" "$HEIGHT" "$CornerIntensity"
  fi
  if [ $Shadow = true ]; then
    addshadow
  fi
  copytoclipboard
  sendnotif "Full"
  write
}

prenotif() {
  if [ $PreNotification = true ]; then
    notify-send -t 2000 "Taking screenshot..." "Please wait.. (You can do other things while you wait.)"
    # just cuz processing takes a while
  fi
}

MODE=$1

while [ $# -gt 0 ]; do
  key="$2"
  case $key in
    -d | --silence)
      Notification=false
      PreNotification=false
      NotificationImage=false
      shift
      ;;

    -o | --pasteonce)
      PasteOnce=true
      shift
      ;;
    
    -s | --shadow)
      Shadow=true
      shift
      ;;

    -i | --noimage)
      NotificationImage=false
      shift
      ;;

    -c | --corner)
      shift
      if [ $# -gt 0 ]; then
        CornerIntensity="$2"
        shift
      else
        echo "Error: Missing argument for $1 option."
        exit 1
      fi
      ;;
    -n | --nocopy)
      CopyToClipboard=false
      shift
      ;;
    -w | --write)
      WriteImage=true
      shift
      ;;
    -p | --writedir)
      shift
      echo $2
      if [ -d "$2" ]; then
        WriteDirectory=$2
        shift
      else
        echo "Error: Invalid argument for $1 option. Check if directory exists"
        exit 1
      fi
      ;;

    *)
      break
      ;;

  esac
done

# Args handler
if [ "$MODE" = "area" ]; then
  area
elif [ "$MODE" = "window" ]; then
  window
elif [ "$MODE" = "full" ]; then
  full
elif [ "$MODE" = "usage" ]; then
  usage
else
  echo "No action supplied."
  usage
fi
